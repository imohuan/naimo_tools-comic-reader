import{d as ge,r as I,c as G,a as me,w as J,o as ye,b as ke,e as T,f as x,g,h as l,i as ce,j as p,k as re,l as v,u,t as P,F as Q,m as ie,n as de,p as fe,q as O,s as pe,v as le,x as xe,S as Me,y as $e,z as Ie,A as Se,B as Te}from"./main.Ai_8gEU-.js";import{u as ve,_ as he,B as Ce,F as ze,b as be,a as De}from"./HotkeyBinding.vue_vue_type_script_setup_true_lang.BOrO1eqK.js";const Re={class:"flex-1 overflow-hidden flex flex-col"},Le={class:"p-2 border-b border-gray-800/50 shrink-0"},je={class:"flex items-center gap-2 mb-2"},Ae={key:0,class:"text-xs text-gray-500"},Ee={key:0,class:"flex-1 flex items-center justify-center"},Be={key:1,class:"flex-1 flex items-center justify-center"},Pe={key:2,class:"text-center py-10 text-gray-600 text-xs flex-1 flex items-center justify-center"},Fe={key:0,class:"p-2 pr-3"},Ne={key:0,class:"mb-1"},Ve=["onClick","onContextmenu"],We={class:"w-12 h-16 bg-gray-800 rounded-sm overflow-hidden border border-white/10 flex items-center justify-center flex-shrink-0 relative"},Ue={class:"flex-1 min-w-0 flex flex-col overflow-hidden"},He=["title"],Ke=["onContextmenu"],Oe={class:"w-12 h-16 bg-gray-800 rounded-sm overflow-hidden border border-white/10 flex items-center justify-center flex-shrink-0 relative"},qe={class:"absolute bottom-0 right-0 px-1 py-0.5 bg-black/60 text-[8px] text-gray-200"},Ye={class:"flex-1 w-full"},Xe=["title"],Ze={class:"pl-14 pr-2 py-1 space-y-1"},Je=["onClick"],Ge=["title"],Qe=["onClick","onContextmenu"],et={class:"w-full aspect-[9/16] bg-gray-800 overflow-hidden relative"},tt={class:"absolute top-2 right-2 px-1.5 py-0.5 bg-black/70 text-[10px] text-gray-200 rounded"},nt={key:0,class:"absolute bottom-2 left-2 px-1.5 py-0.5 bg-green-500/80 text-[10px] text-white rounded"},ot={class:"p-2 bg-[#18181c]"},rt=["title"],lt=["onClick"],st=["title"],at=ge({__name:"MangaList",setup(we){const r=ve(),w=I(null),t=I(null),C=G(()=>{const n=r.sidebarWidth;return n<=250?80:n<=350?100:n<=450?120:140}),D=G(()=>{const n=r.sidebarWidth-20,o=C.value*2+8;return r.sidebarWidth<220||n<o}),F=G(()=>D.value?"1fr":`repeat(auto-fill, minmax(${C.value}px, 1fr))`);function B(n){return r.expandedMode&&n.meta.chapterInfos.length===1?`${n.name} - ${n.meta.chapterInfos[0].chapterTitle}`:n.name}function q(n){return r.currentManga?.name!==n.name?!1:r.expandedMode&&n.meta.chapterInfos.length===1?r.currentChapter===n.meta.chapterInfos[0].chapterTitle:!0}const E=G(()=>{let n=r.mangas;if(r.searchKeyword.trim()){const o=r.searchKeyword.toLowerCase().trim();n=n.filter(m=>B(m).toLowerCase().includes(o))}return n}),h=me({}),i=me({}),b=new Set;J(()=>r.mangas.map(n=>n.name),n=>{n.forEach(o=>{i[o]||(i[o]={key:o,index:0,filename:o,path:"",url:""})})},{immediate:!0});const _=I(!1);J(()=>r.expandedMode,async()=>{if(_.value=!0,r.setMangas([]),Object.keys(h).forEach(n=>{delete h[n]}),b.clear(),window.$loadMangaList)try{await window.$loadMangaList(!1)}catch(n){console.error("切换模式后恢复列表失败:",n)}finally{_.value=!1}else _.value=!1}),J(()=>r.mangas,n=>{const o=new Set;n.forEach(m=>{o.add(S(m))}),Object.keys(h).forEach(m=>{o.has(m)||delete h[m]}),b.forEach(m=>{o.has(m)||b.delete(m)})},{deep:!0});function U(){return w.value?.containerRef||null}function S(n){return r.expandedMode&&n.meta.chapterInfos.length===1?`${n.name}::${n.meta.chapterInfos[0].chapterTitle}`:n.name}async function Y(n){const o=S(n);h[o]||b.has(o)||await N(n)}async function N(n){const o=S(n);if(!b.has(o)){b.add(o);try{if(n.meta.chapterInfos.length===0)return;const m=n.meta.chapterInfos[0],M=[...r.staticDirs].map(X=>String(X)),Z=await window.comicReaderAPI.getChapterImages(M,String(n.name),String(m.chapterTitle));if(Z.length===0)return;const W=Z[0];let K=W.path;if(!K&&W.url.startsWith("file://")&&(K=decodeURIComponent(W.url.replace(/^file:\/\/\//,""))),!K)return;h[o]={key:o,index:0,filename:W.filename||n.name,path:K,url:W.url||"",mtimeMs:W.mtimeMs}}catch(m){console.error(`[MangaList] loadCoverImage: ${o} 加载失败`,m)}finally{b.delete(o)}}}const ee=I(0),te=I(0),z=I(!1),L=I(null),V=I([]),a=I(0),e=I(0),c=I(!1),k=I(null),H=I([]);function se(n){return r.currentManga?.name===n.name&&r.currentChapter?n.name:null}async function R(n,o){if(n.meta.chapterInfos.length===0){window.$message&&window.$message.warning("该漫画没有章节");return}r.setCurrentManga(n),await s(n,o)}async function ne(n,o){const m=o.meta.chapterInfos;if(m.length===0){window.$message&&window.$message.warning("该漫画没有章节");return}if(r.expandedMode||m.length===1)await R(o,m[0].chapterTitle);else{k.value=o,H.value=m.map(ue=>({label:ue.chapterTitle,key:ue.chapterTitle})),await le();const M=250,K=Math.min(m.length*44,400),X=10;let ae=n.clientX,oe=n.clientY;ae+M>window.innerWidth-X&&(ae=window.innerWidth-M-X),ae<X&&(ae=X),oe+K>window.innerHeight-X&&(oe=oe-K),oe<X&&(oe=X),a.value=ae,e.value=oe,n.stopPropagation(),c.value=!0}}async function s(n,o){r.setCurrentManga(n),r.setCurrentChapter(o),r.setLoading("chapter",!0);try{const m=[...r.staticDirs].map(Z=>String(Z)),M=await window.comicReaderAPI.getChapterImages(m,String(n.name),String(o));r.setCurrentImages(M)}catch(m){console.error("加载章节失败:",m),window.$message&&window.$message.error("加载章节失败"),window.naimo&&window.naimo.log.error("加载章节失败",m)}finally{r.setLoading("chapter",!1)}}function f(n,o){n.preventDefault(),L.value=o,ee.value=n.clientX,te.value=n.clientY,V.value=[{label:"顶置",key:"pin"},{label:"打开文件夹",key:"openFolder"},{label:"删除",key:"delete"}],z.value=!0}async function y(n){const o=L.value;if(o){if(n==="pin")await r.pinManga(o.name);else if(n==="openFolder")try{const m=[...r.staticDirs].map(M=>String(M));await window.comicReaderAPI.openMangaFolder(m,o.name)}catch(m){console.error("打开文件夹失败",m),window.$message&&window.$message.error("打开文件夹失败")}else n==="delete"&&await r.deleteManga(o.name);z.value=!1}}async function $(n){const o=k.value;o&&(await R(o,n),c.value=!1)}function j(n){if(c.value&&t.value){const o=n.target;t.value.contains(o)||(c.value=!1)}}return ye(()=>{document.addEventListener("click",j)}),ke(()=>{document.removeEventListener("click",j)}),(n,o)=>{const m=T("n-input"),M=T("n-button"),Z=T("n-button-group"),W=T("n-spin"),K=T("n-tag"),X=T("n-collapse-item"),ae=T("n-collapse"),oe=T("n-scrollbar"),ue=T("n-dropdown");return g(),x("div",Re,[l("div",Le,[l("div",je,[p(m,{value:u(r).searchKeyword,"onUpdate:value":o[0]||(o[0]=d=>u(r).searchKeyword=d),placeholder:"搜索漫画...",size:"small",clearable:"",class:"flex-1"},{prefix:v(()=>[...o[6]||(o[6]=[l("svg",{class:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1)])]),_:1},8,["value"]),p(Z,{size:"small"},{default:v(()=>[p(M,{type:u(r).listLayoutMode==="list"?"primary":"default",onClick:o[1]||(o[1]=d=>u(r).setListLayoutMode("list"))},{icon:v(()=>[...o[7]||(o[7]=[l("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 6h16M4 12h16M4 18h16"})],-1)])]),_:1},8,["type"]),p(M,{type:u(r).listLayoutMode==="grid"?"primary":"default",onClick:o[2]||(o[2]=d=>u(r).setListLayoutMode("grid"))},{icon:v(()=>[...o[8]||(o[8]=[l("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"})],-1)])]),_:1},8,["type"])]),_:1})]),E.value.length>0?(g(),x("div",Ae," 共 "+P(E.value.length)+" 部漫画 ",1)):re("",!0)]),_.value?(g(),x("div",Ee,[p(W,{size:"large"},{description:v(()=>[...o[9]||(o[9]=[l("span",{class:"text-gray-400 text-xs"},"切换显示模式中...",-1)])]),_:1})])):E.value.length===0&&u(r).loading.library?(g(),x("div",Be,[p(W,{size:"large"},{description:v(()=>[...o[10]||(o[10]=[l("span",{class:"text-gray-400 text-xs"},"正在加载漫画列表...",-1)])]),_:1})])):E.value.length===0&&!u(r).loading.library?(g(),x("div",Pe,P(u(r).searchKeyword?"未找到匹配的漫画":"暂无数据"),1)):(g(),ce(oe,{key:3,ref_key:"scrollbarRef",ref:w,class:"menu viewer flex-1",onClick:o[3]||(o[3]=d=>z.value=!1)},{default:v(()=>[u(r).listLayoutMode==="list"?(g(),x("div",Fe,[(g(!0),x(Q,null,ie(E.value,d=>(g(),x(Q,{key:d.name},[d.meta.chapterInfos.length===1?(g(),x("div",Ne,[l("div",{class:fe(["group flex items-center gap-2 rounded cursor-pointer transition-colors hover:bg-white/5",{"bg-green-500/10 text-green-400":u(r).currentManga?.name===d.name&&u(r).currentChapter===d.meta.chapterInfos[0].chapterTitle}]),onClick:A=>R(d,d.meta.chapterInfos[0].chapterTitle),onContextmenu:de(A=>f(A,d),["prevent"])},[l("div",We,[p(he,{item:h[S(d)]||i[d.name],"file-path":h[S(d)]?.path||"","get-scroll-container":U,"img-style":{width:"100%",height:"100%",objectFit:"cover"},"img-class":"w-full h-full object-cover",onVisible:A=>Y(d)},null,8,["item","file-path","onVisible"]),o[11]||(o[11]=l("div",{class:"absolute bottom-0 right-0 px-1 py-0.5 bg-black/60 text-[8px] text-gray-200"}," 封面 ",-1))]),l("div",Ue,[l("span",{class:"text-xs truncate font-medium leading-tight",title:B(d)},P(B(d)),9,He),p(K,{size:"small",bordered:!1,class:"text-[10px] h-4 px-1 bg-white/5 text-gray-500 mt-1 self-start"},{default:v(()=>[...o[12]||(o[12]=[O(" 单章 ",-1)])]),_:1})])],42,Ve)])):(g(),ce(ae,{key:1,"default-expanded-names":se(d),"arrow-placement":"right",class:"mb-1"},{default:v(()=>[p(X,{name:d.name,class:"w-full"},{header:v(()=>[l("div",{class:"flex items-center gap-2 w-full",onContextmenu:de(A=>f(A,d),["prevent"])},[l("div",Oe,[p(he,{item:h[S(d)]||i[d.name],"file-path":h[S(d)]?.path||"","get-scroll-container":U,"img-style":{width:"100%",height:"100%",objectFit:"cover"},"img-class":"w-full h-full object-cover",onVisible:A=>Y(d)},null,8,["item","file-path","onVisible"]),l("div",qe,P(d.meta.chapterInfos.length),1)]),l("div",Ye,[l("span",{class:"text-xs font-medium leading-tight",title:B(d)},P(B(d)),9,Xe)]),p(K,{size:"small",bordered:!1,class:"text-[10px] h-4 px-1 bg-white/5 text-gray-500 flex-shrink-0"},{default:v(()=>[O(P(d.meta.chapterInfos.length)+"章 ",1)]),_:2},1024)],40,Ke)]),default:v(()=>[l("div",Ze,[(g(!0),x(Q,null,ie(d.meta.chapterInfos,A=>(g(),x("div",{key:A.chapterId,class:fe(["px-2 py-1.5 rounded cursor-pointer text-xs transition-colors hover:bg-white/5",{"bg-green-500/10 text-green-400":u(r).currentManga?.name===d.name&&u(r).currentChapter===A.chapterTitle}]),onClick:Nt=>R(d,A.chapterTitle)},[l("span",{class:"truncate block",title:A.chapterTitle},P(A.chapterTitle),9,Ge)],10,Je))),128))])]),_:2},1032,["name"])]),_:2},1032,["default-expanded-names"]))],64))),128))])):(g(),x("div",{key:1,class:"p-2 pr-3 grid gap-2",style:pe({gridTemplateColumns:F.value})},[(g(!0),x(Q,null,ie(E.value,d=>(g(),x("div",{key:d.name,class:"group cursor-pointer transition-all hover:scale-[1.02]",style:pe({minWidth:D.value?"0":`${C.value}px`}),onClick:A=>ne(A,d),onContextmenu:de(A=>f(A,d),["prevent"])},[l("div",{class:fe(["rounded overflow-hidden border-2 transition-all",{"border-white bg-white shadow-lg shadow-gray-500/30":q(d),"border-gray-800 hover:border-gray-700":!q(d)}])},[l("div",et,[p(he,{item:h[S(d)]||i[d.name],"file-path":h[S(d)]?.path||"","get-scroll-container":U,"img-style":{width:"100%",height:"100%",objectFit:"cover"},"img-class":"w-full h-full object-cover",onVisible:A=>Y(d)},null,8,["item","file-path","onVisible"]),l("div",tt,P(d.meta.chapterInfos.length)+"章 ",1),d.meta.chapterInfos.length===1?(g(),x("div",nt," 单章 ")):re("",!0)]),l("div",ot,[l("div",{class:"text-xs font-medium leading-tight line-clamp-2 text-gray-200",title:B(d)},P(B(d)),9,rt)])],2)],44,Qe))),128))],4))]),_:1},512)),p(ue,{placement:"bottom-start",trigger:"manual",show:z.value,x:ee.value,y:te.value,options:V.value,onSelect:y,onClickoutside:o[4]||(o[4]=d=>z.value=!1)},null,8,["show","x","y","options"]),c.value?(g(),x("div",{key:4,ref_key:"chapterMenuDropdown",ref:t,class:"fixed z-50 min-w-[200px] max-w-[300px] max-h-[400px] overflow-y-auto overflow-x-hidden bg-gray-800 border border-gray-600 rounded-lg shadow-xl",style:pe({left:a.value+"px",top:e.value+"px"}),onClick:o[5]||(o[5]=de(()=>{},["stop"]))},[(g(!0),x(Q,null,ie(H.value,d=>(g(),x("div",{key:d.key,class:"px-3 py-2 cursor-pointer transition-colors border-b border-gray-700 last:border-b-0 hover:bg-gray-700",onClick:A=>$(d.key)},[l("span",{class:"block w-full whitespace-nowrap overflow-hidden text-ellipsis text-gray-200 text-sm leading-normal",title:d.label},P(d.label),9,st)],8,lt))),128))],4)):re("",!0)])}}}),it={class:"w-full flex flex-col items-center gap-0 py-0"},ct={class:"absolute top-3 left-3 z-10 flex opacity-0 group-hover:opacity-100 transition-opacity"},ut=40,_e=ge({__name:"ImageViewer",setup(we,{expose:r}){const w=ve(),t=xe(),C=I(null),D=I(null),F=I(null),B=I(0);I(!1);const q=I(!1),E=me(new Map),h=me(new Set),i=G(()=>w.currentManga?.name===Ce),b=new Map,_=G(()=>w.currentImages.map((s,f)=>({key:`${s.url}-${f}`,...s,index:f}))),U=G(()=>{const s=w.virtualMaxRenderCount??100,f=typeof s=="number"?s:Number(s)||100;return Math.max(20,Math.min(500,f))}),S=G(()=>{const f=_.value.length,y=U.value;if(f<=y)return 0;const $=Math.min(Math.max(0,w.currentPage-1),f-1);let j=Math.max(0,$-ut),n=Math.min(f,j+y);return n-j<y&&(j=Math.max(0,n-y)),j}),Y=G(()=>{const s=_.value,f=U.value;if(s.length<=f)return s;const y=S.value,$=Math.min(s.length,y+f);return s.slice(y,$)});function N(){if(D.value?.containerRef)return D.value.containerRef;if(F.value)return F.value;const s=document.getElementById("image-scroll-container");if(s){const f=s.querySelector(".n-scrollbar-container")||s;return F.value=f,f}return null}r({scrollContainerRef:F,getScrollContainer:N,scrollBy:s=>{const f=N();if(f)f.scrollTop+=s;else if(D.value?.scrollTo){const y=B.value;D.value.scrollTo({top:y+s})}}});function ee(s,f){s&&f?b.set(f.key,s):!s&&f&&b.delete(f.key)}function te(){return{transform:`rotate(${w.rotation}deg)`,width:"100%"}}function z(s){return E.has(s)}function L(s){return h.has(s)}function V(){return(w.staticDirs||[]).map(s=>String(s||"").trim()).filter(s=>s)}async function a(s){const f=s.key,y=V();if(y.length===0){t.warning("请先在设置中配置本地目录");return}if(h.has(f))return;const $=be({comicTitle:w.currentManga?.name||"本地漫画",chapterTitle:w.currentChapter||"章节",originalName:s.filename,index:s.index+1});h.add(f);try{if(!s.path)throw new Error("图片路径不可用");await window.comicReaderAPI.saveImageToFavorites({staticDirs:y,filename:$,sourcePath:s.path}),E.set(f,$),t.success("已添加收藏")}catch(j){console.error("收藏图片失败:",j),t.error(j?.message||"收藏失败")}finally{h.delete(f)}}async function e(s){const f=s.key,y=V();if(y.length===0){t.warning("请先在设置中配置本地目录");return}if(h.has(f))return;const $=E.get(f)||be({comicTitle:w.currentManga?.name||"本地漫画",chapterTitle:w.currentChapter||"章节",originalName:s.filename,index:s.index+1});h.add(f);try{await window.comicReaderAPI.removeFavoriteImage({staticDirs:y,filename:$}),E.delete(f),t.success("已取消收藏")}catch(j){console.error("取消收藏失败:",j),t.error(j?.message||"操作失败")}finally{h.delete(f)}}function c(){H()}function k(s){s.target.style.display="none"}function H(){const s=N();if(!s||!C.value)return;const f=s.scrollTop+s.clientHeight/2;let y=0,$=Number.POSITIVE_INFINITY;Y.value.forEach((o,m)=>{const M=b.get(o.key);if(!M)return;const W=M.offsetTop+M.clientHeight/2,K=Math.abs(W-f);K<$&&($=K,y=m)});const j=S.value+y,n=Math.min(Math.max(1,j+1),w.currentImages.length);n!==w.currentPage&&w.setCurrentPage(n)}function se(s){const f=s.target;B.value=f.scrollTop,H()}function R(s){if(s.ctrlKey||s.metaKey){s.preventDefault();const f=s.deltaY>0?-5:5,y=N();let $=null;if(y&&_.value.length>0){const o=Math.min(Math.max(0,w.currentPage-1),_.value.length-1),m=_.value[o],M=m?b.get(m.key):null;M?$=M.offsetTop+M.clientHeight/2-y.scrollTop:$=y.clientHeight/2}const j=Math.max(10,Math.min(100,w.zoom+f)),n=w.zoom;if(j===n)return;w.setZoom(j),le(()=>{if(!y||$==null)return;const o=Math.min(Math.max(0,w.currentPage-1),_.value.length-1),m=_.value[o],M=m?b.get(m.key):null;if(!M)return;const W=M.offsetTop+M.clientHeight/2-$;y.scrollTo({top:Math.max(0,W),left:0})})}}function ne(){const s=N();le(()=>{D.value?.scrollTo?D.value.scrollTo({left:0,top:0}):s&&s.scrollTo({left:0,top:0}),B.value=0})}return J(()=>w.currentManga?.name,()=>{ne()}),J(()=>w.currentChapter,()=>{if(q.value){q.value=!1;return}ne()}),J(()=>w.zoom,()=>{le(()=>{H()})}),J(_,s=>{b.clear(),E.clear(),h.clear(),i.value&&s.length>0&&s.forEach(f=>{E.set(f.key,f.filename)})},{immediate:!0}),ye(()=>{le(()=>{F.value=N(),D.value?.scrollTo&&D.value.scrollTo({left:0,top:0})})}),(s,f)=>(g(),x("div",{ref_key:"viewerContainer",ref:C,class:"viewer flex-1 relative bg-[#050505] overflow-hidden outline-none focus:outline-none",tabindex:"-1"},[p(u(Me),{ref_key:"scrollbarRef",ref:D,id:"image-scroll-container",class:"menu viewer h-full w-full",style:{height:"100%"},onScroll:se,onWheel:R},{default:v(()=>[l("div",it,[(g(!0),x(Q,null,ie(Y.value,y=>(g(),x("div",{key:y.key,class:"w-full flex items-center justify-center outline-none focus:outline-none ring-0 focus:ring-0 relative group",style:pe(te()),ref_for:!0,ref:$=>ee($,y)},[l("div",ct,[p(ze,{favorited:z(y.key),loading:L(y.key),onAdd:$=>a(y),onRemove:$=>e(y)},null,8,["favorited","loading","onAdd","onRemove"])]),p(he,{item:y,"file-path":y.path,"img-style":{width:`${u(w).zoom}%`},"img-class":"block mx-auto max-w-full w-auto h-auto object-contain bg-[#111] select-none outline-none focus:outline-none ring-0 focus:ring-0","get-scroll-container":N,onLoaded:c,onError:k},null,8,["item","file-path","img-style"])],4))),128))])]),_:1},512)],512))}}),dt={class:"flex items-center justify-between mb-3"},ft={key:0,class:"text-center text-gray-500 py-4"},pt={class:"flex items-center justify-between"},ht={class:"flex items-center gap-4 w-64"},mt={class:"flex items-center justify-between"},gt={class:"flex items-center gap-4 w-64"},vt={class:"text-sm font-mono w-10"},wt=ge({__name:"SettingsPanel",setup(we){const r=ve(),w=xe(),t=$e(),C={scrollDown:{label:"向下滚动"},scrollUp:{label:"向上滚动"},autoScroll:{label:"切换自动滚动"},speedUp:{label:"增加滚动速度"},speedDown:{label:"减少滚动速度"},nextChapter:{label:"下一章"},prevChapter:{label:"上一章"}};function D(h,i){r.hotkeys[h]=i}async function F(){const h=await window.comicReaderAPI.selectMangaDirectory();if(h){if(r.staticDirs.includes(h)){w.warning("该目录已存在");return}r.addStaticDir(h),w.success(`已添加目录: ${h}`),window.naimo&&window.naimo.log.info(`已添加目录: ${h}`),window.$loadMangaList&&await window.$loadMangaList(!0)}}async function B(h){const i=r.staticDirs[h],b=await window.comicReaderAPI.selectMangaDirectory();if(b&&b!==i){if(r.staticDirs.includes(b)){w.warning("该目录已存在");return}r.staticDirs[h]=b,w.success(`已修改目录: ${i} -> ${b}`),window.naimo&&window.naimo.log.info(`已修改目录: ${i} -> ${b}`),window.$loadMangaList&&await window.$loadMangaList(!0)}}async function q(h){const i=r.staticDirs[h];if(!i||i.trim()===""){w.warning("目录路径不能为空");return}if(r.staticDirs.findIndex((_,U)=>_===i&&U!==h)!==-1){w.warning("该目录已存在");return}window.$loadMangaList&&await window.$loadMangaList(!0)}function E(h){const i=r.staticDirs[h];t.warning({title:"确认删除",content:`确定要删除目录 "${i}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:()=>{r.removeStaticDir(i),w.success(`已删除目录: ${i}`),window.naimo&&window.naimo.log.info(`已删除目录: ${i}`),window.$loadMangaList&&window.$loadMangaList(!0)}})}return(h,i)=>{const b=T("n-h3"),_=T("n-button"),U=T("n-input"),S=T("n-space"),Y=T("n-input-number"),N=T("n-slider"),ee=T("n-drawer-content"),te=T("n-drawer");return g(),ce(te,{show:u(r).showSettings,"onUpdate:show":i[2]||(i[2]=z=>u(r).showSettings=z),width:500,placement:"right","mask-closable":!0},{default:v(()=>[p(ee,{title:"设置",closable:""},{default:v(()=>[p(S,{vertical:"",size:24},{default:v(()=>[l("div",null,[l("div",dt,[p(b,{style:{margin:"0"}},{default:v(()=>[...i[3]||(i[3]=[O("目录管理",-1)])]),_:1}),p(_,{size:"small",type:"primary",onClick:F},{icon:v(()=>[...i[4]||(i[4]=[l("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1)])]),default:v(()=>[i[5]||(i[5]=O(" 添加目录 ",-1))]),_:1})]),p(S,{vertical:"",size:8},{default:v(()=>[(g(!0),x(Q,null,ie(u(r).staticDirs,(z,L)=>(g(),x("div",{key:L,class:"flex items-center gap-2 p-2 rounded border border-gray-700 bg-gray-800/30"},[p(U,{value:u(r).staticDirs[L],"onUpdate:value":V=>u(r).staticDirs[L]=V,size:"small",class:"flex-1",spellcheck:"false",onBlur:V=>q(L),onKeydown:Ie(V=>q(L),["enter"])},null,8,["value","onUpdate:value","onBlur","onKeydown"]),p(_,{size:"small",quaternary:"",onClick:V=>B(L)},{icon:v(()=>[...i[6]||(i[6]=[l("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"})],-1)])]),_:1},8,["onClick"]),p(_,{size:"small",quaternary:"",type:"error",onClick:V=>E(L)},{default:v(()=>[...i[7]||(i[7]=[O(" 删除 ",-1)])]),_:1},8,["onClick"])]))),128)),u(r).staticDirs.length===0?(g(),x("div",ft," 暂无目录，请添加目录 ")):re("",!0)]),_:1})]),l("div",null,[p(b,null,{default:v(()=>[...i[8]||(i[8]=[O("阅读性能",-1)])]),_:1}),p(S,{vertical:"",size:12},{default:v(()=>[l("div",pt,[i[9]||(i[9]=l("span",null,"最大同时渲染图片数",-1)),l("div",ht,[p(Y,{value:u(r).virtualMaxRenderCount,"onUpdate:value":i[0]||(i[0]=z=>u(r).virtualMaxRenderCount=z),min:20,max:500,step:10,size:"small",style:{width:"160px"}},null,8,["value"])])])]),_:1})]),l("div",null,[p(b,null,{default:v(()=>[...i[10]||(i[10]=[O("快捷键设置",-1)])]),_:1}),p(S,{vertical:"",size:16},{default:v(()=>[(g(),x(Q,null,ie(C,(z,L)=>p(De,{key:L,label:z.label,"action-key":L,"current-key":u(r).hotkeys[L],onUpdate:D},null,8,["label","action-key","current-key"])),64))]),_:1})]),l("div",null,[p(b,null,{default:v(()=>[...i[11]||(i[11]=[O("自动滚动设置",-1)])]),_:1}),p(S,{vertical:"",size:12},{default:v(()=>[l("div",mt,[i[12]||(i[12]=l("span",null,"滚动速度",-1)),l("div",gt,[p(N,{value:u(r).autoScrollSpeed,"onUpdate:value":i[1]||(i[1]=z=>u(r).autoScrollSpeed=z),min:1,max:10,step:1,tooltip:!1,style:{width:"200px"}},null,8,["value"]),l("span",vt,P(u(r).autoScrollSpeed),1)])])]),_:1})])]),_:1})]),_:1})]),_:1},8,["show"])}}}),yt={class:"w-full h-screen overflow-hidden select-none bg-[#101014] text-gray-200 flex flex-col"},xt={class:"min-h-14 border-b border-gray-800 bg-[#18181c] flex items-center px-4 justify-between shrink-0 z-20"},bt={class:"flex items-center gap-4 min-w-0 flex-1"},_t={class:"flex items-center gap-3 min-w-0 flex-1"},kt=["title"],Ct={key:0,class:"bg-black/80 backdrop-blur px-4 py-1.5 rounded-full border border-gray-800 flex items-center gap-4 shadow-xl shrink-0"},Mt={class:"text-xs text-gray-300 font-bold"},$t={class:"text-xs font-mono text-green-400"},It={class:"flex items-center gap-4 shrink-0"},St={class:"flex items-center gap-2"},Tt={class:"text-xs font-mono w-10 text-right text-gray-400"},zt={class:"bg-[#18181c] border-r border-gray-800 flex flex-col h-full z-10 overflow-hidden"},Dt={class:"p-3 flex justify-between items-center border-b border-gray-800/50 shrink-0"},Rt={class:"flex items-center gap-2"},Lt={class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},jt={key:0,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"},At={key:1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},Et={class:"flex-1 relative bg-[#050505] flex flex-col overflow-hidden h-full"},Bt={key:0,class:"absolute inset-0 flex flex-col items-center justify-center z-30 bg-black/50 backdrop-blur-sm"},Pt={class:"flex-1 relative bg-[#050505] flex flex-col overflow-hidden h-full"},Ft={key:0,class:"absolute inset-0 flex flex-col items-center justify-center z-30 bg-black/50 backdrop-blur-sm"},Ut=ge({__name:"ComicReaderContent",setup(we){const r=xe(),w=Te(),t=ve(),C=I(null),D=I(null),F=I(.2);function B(){return D.value?D.value.offsetWidth||D.value.clientWidth:window.innerWidth||1920}function q(a){const e=B();return e===0?.2:Math.max(.1,Math.min(.5,a/e))}function E(a){const e=B(),c=a*e;return Math.max(200,Math.min(800,c))}function h(a){const e=E(a);t.setSidebarWidth(e)}J(()=>t.sidebarWidth,a=>{le(()=>{F.value=q(a)})},{immediate:!0}),J(()=>t.sidebarCollapsed,a=>{a||le(()=>{F.value=q(t.sidebarWidth)})});let i=null;function b(){w.push("/jmcomic")}async function _(a=!1){if(t.staticDirs.length===0){r.warning("请先选择漫画目录");return}if(!a){const e=t.getCachedMangas();if(e&&e.length>0){t.setMangas(e),await V(e);return}}a&&t.setMangas([]),t.setLoading("library",!0);try{const e=[...t.staticDirs].map(k=>String(k)),c=await window.comicReaderAPI.getMangaList(e,t.expandedMode);t.setMangas(c),t.setCachedMangas(c),await V(c)}catch(e){console.error("加载漫画列表失败:",e),r.error("加载漫画列表失败"),window.naimo&&window.naimo.log.error("加载漫画列表失败",e)}finally{t.setLoading("library",!1)}}function U(){const a=document.activeElement;return a?a.tagName==="INPUT"||a.tagName==="TEXTAREA"||a.isContentEditable:!1}function S(){i||(i=window.setInterval(()=>{if(!C.value||U())return;const a=t.autoScrollSpeed*2;if(C.value.scrollBy){C.value.scrollBy(a);return}const e=C.value.getScrollContainer?.();if(e){e.scrollTop+=a;return}const c=C.value.$el;if(c){const k=c.querySelector(".n-scrollbar-container")||c.querySelector(".n-virtual-list")||c.querySelector('[style*="overflow"]');k&&(k.scrollTop+=a)}},16))}function Y(){i&&(clearInterval(i),i=null)}J(()=>t.autoScroll,a=>{a?S():Y()});function N(a){const e=a.code,c=t.hotkeys;if(!U())if(e===c.scrollDown){if(a.preventDefault(),C.value){if(C.value.scrollBy){C.value.scrollBy(100);return}const k=C.value.getScrollContainer?.();if(k){k.scrollTop+=100;return}}}else if(e===c.scrollUp){if(a.preventDefault(),C.value){if(C.value.scrollBy){C.value.scrollBy(-100);return}const k=C.value.getScrollContainer?.();if(k){k.scrollTop-=100;return}}}else e===c.autoScroll?(a.preventDefault(),t.toggleAutoScroll()):e===c.speedUp?(a.preventDefault(),t.setAutoScrollSpeed(Math.min(10,t.autoScrollSpeed+1))):e===c.speedDown?(a.preventDefault(),t.setAutoScrollSpeed(Math.max(1,t.autoScrollSpeed-1))):e===c.nextChapter?(a.preventDefault(),ee()):e===c.prevChapter&&(a.preventDefault(),te())}async function ee(){if(!t.currentManga||t.loading.chapter)return;const a=t.currentManga.meta.chapterInfos;if(a.length<=1)return;const e=a.findIndex(c=>c.chapterTitle===t.currentChapter);if(e>=0&&e<a.length-1){const c=a[e+1];await z(t.currentManga,c.chapterTitle)}else r.info("已经是最后一章了")}async function te(){if(!t.currentManga||t.loading.chapter)return;const a=t.currentManga.meta.chapterInfos;if(a.length<=1)return;const e=a.findIndex(c=>c.chapterTitle===t.currentChapter);if(e>0){const c=a[e-1];await z(t.currentManga,c.chapterTitle)}else r.info("已经是第一章了")}async function z(a,e){if(!(!a||!e)){t.setCurrentChapter(e),t.setLoading("chapter",!0);try{const c=[...t.staticDirs].map(H=>String(H)),k=await window.comicReaderAPI.getChapterImages(c,String(a.name),String(e));t.setCurrentImages(L(a.name,k??[]))}catch(c){console.error("加载章节失败:",c),r.error("加载章节失败")}finally{t.setLoading("chapter",!1)}}}function L(a,e){return a!==Ce?e:[...e].sort((c,k)=>(k.mtimeMs??0)-(c.mtimeMs??0))}async function V(a){const e=t.currentManga?.name;if(!e)return;const c=a.find(ne=>ne.name===e);if(!c){t.setCurrentManga(null),t.setCurrentChapter(""),t.setCurrentImages([]);return}const k=t.currentChapter;if(t.setCurrentManga(c),!k)return;const H=c.meta.chapterInfos.some(ne=>ne.chapterTitle===k),se=c.meta.chapterInfos[0]?.chapterTitle,R=H?k:se;if(R){await z(c,R);return}t.setCurrentChapter(""),t.setCurrentImages([])}return Se("Tab",a=>{const e=a.target;e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.isContentEditable||(a.preventDefault(),t.toggleSidebar())}),ye(async()=>{await le(),window.$message=r,window.$loadMangaList=_,window.addEventListener("keydown",N),window.naimo&&window.naimo.onEnter(async a=>{console.log("漫画阅读功能被触发",a),window.naimo.log.info("漫画阅读器已加载")}),t.autoScroll&&S(),window.naimo&&window.naimo.log.info("漫画阅读器初始化完成"),setTimeout(async()=>{t.staticDirs.length>0&&await _(!0)},100)}),ke(()=>{Y(),window.removeEventListener("keydown",N)}),(a,e)=>{const c=T("n-button"),k=T("n-slider"),H=T("n-spin"),se=T("n-split");return g(),x("div",yt,[l("header",xt,[l("div",bt,[p(c,{text:"",onClick:e[0]||(e[0]=R=>u(t).toggleSidebar()),class:"text-gray-400 hover:text-white"},{icon:v(()=>[...e[8]||(e[8]=[l("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 6h16M4 12h16M4 18h16"})],-1)])]),_:1}),l("div",_t,[l("span",{class:"font-bold text-sm text-gray-200 line-clamp-1 truncate max-w-1/3 inline-block",title:u(t).currentManga?.name},P(u(t).currentManga?.name||"未选择漫画"),9,kt),u(t).currentChapter||u(t).currentPageInfo?(g(),x("div",Ct,[l("span",Mt,P(u(t).currentChapter||"--"),1),e[9]||(e[9]=l("div",{class:"w-px h-3 bg-gray-600"},null,-1)),l("span",$t,P(u(t).currentPageInfo),1)])):re("",!0)])]),l("div",It,[p(c,{type:u(t).autoScroll?"primary":"default",size:"small",onClick:e[1]||(e[1]=R=>u(t).toggleAutoScroll())},{icon:v(()=>[...e[10]||(e[10]=[l("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 14l-7 7m0 0l-7-7m7 7V3"})],-1)])]),default:v(()=>[O(" "+P(u(t).autoScroll?"停止滚动":"自动滚动"),1)]),_:1},8,["type"]),p(c,{size:"small",onClick:e[2]||(e[2]=R=>u(t).toggleSettings())},{icon:v(()=>[...e[11]||(e[11]=[l("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})],-1)])]),default:v(()=>[e[12]||(e[12]=O(" 设置 ",-1))]),_:1}),p(c,{size:"small",onClick:e[3]||(e[3]=R=>_(!0))},{default:v(()=>[...e[13]||(e[13]=[O("刷新",-1)])]),_:1}),l("div",St,[e[14]||(e[14]=l("span",{class:"text-xs text-gray-400"},"缩放",-1)),p(k,{value:u(t).zoom,"onUpdate:value":e[4]||(e[4]=R=>u(t).zoom=R),min:10,max:100,step:5,tooltip:!1,style:{width:"100px"},size:"small"},null,8,["value"]),l("span",Tt,P(u(t).zoom)+"%",1)]),p(c,{size:"small",onClick:b},{default:v(()=>[...e[15]||(e[15]=[O("JMComic",-1)])]),_:1})])]),l("div",{ref_key:"containerRef",ref:D,class:"flex flex-1 overflow-hidden relative"},[u(t).sidebarCollapsed?(g(),x(Q,{key:1},[e[20]||(e[20]=l("aside",{class:"bg-[#18181c] border-r border-gray-800 flex flex-col h-full z-10",style:{width:"0",overflow:"hidden",opacity:"0"}},null,-1)),l("main",Pt,[u(t).loading.chapter&&u(t).currentImages.length===0?(g(),x("div",Ft,[p(H,{size:"large"}),e[19]||(e[19]=l("span",{class:"mt-4 text-xs text-green-500 font-mono animate-pulse"},"正在读取数据流...",-1))])):re("",!0),p(_e,{ref_key:"imageViewerRef",ref:C},null,512)])],64)):(g(),ce(se,{key:0,size:F.value,"onUpdate:size":[e[7]||(e[7]=R=>F.value=R),h],max:.5,min:.1,direction:"horizontal",resizable:!0,"resize-trigger-size":8,class:"flex-1 h-full overflow-hidden"},{1:v(()=>[l("aside",zt,[l("div",Dt,[l("div",Rt,[p(c,{text:"",size:"small",type:u(t).expandedMode?"primary":"default",onClick:e[5]||(e[5]=R=>{u(t).toggleExpandedMode(),_(!1)}),title:u(t).expandedMode?"展开模式：每个章节独立显示":"折叠模式：按漫画分组显示"},{icon:v(()=>[(g(),x("svg",Lt,[u(t).expandedMode?(g(),x("path",At)):(g(),x("path",jt))]))]),_:1},8,["type","title"]),e[16]||(e[16]=l("span",{class:"text-xs font-bold text-gray-500 tracking-wider"},"书架 LIBRARY",-1))]),p(c,{text:"",size:"small",onClick:e[6]||(e[6]=R=>_(!0))},{icon:v(()=>[(g(),x("svg",{class:fe(["w-4 h-4",{"animate-spin":u(t).loading.library}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...e[17]||(e[17]=[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},null,-1)])],2))]),_:1})]),p(at)])]),2:v(()=>[l("main",Et,[u(t).loading.chapter&&u(t).currentImages.length===0?(g(),x("div",Bt,[p(H,{size:"large"}),e[18]||(e[18]=l("span",{class:"mt-4 text-xs text-green-500 font-mono animate-pulse"},"正在读取数据流...",-1))])):re("",!0),p(_e,{ref_key:"imageViewerRef",ref:C},null,512)])]),_:1},8,["size"]))],512),u(t).showSettings?(g(),ce(wt,{key:0})):re("",!0)])}}});export{Ut as default};
