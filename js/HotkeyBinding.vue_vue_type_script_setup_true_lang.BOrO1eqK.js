import{r as g,o as F,w as W,C as Se,D as L,c as M,d as O,L as xe,f as k,g as S,s as be,h as w,k as ke,p as j,i as V,l as R,q as K,t as D,n as U,e as q,b as Ce,j as E}from"./main.Ai_8gEU-.js";function Me(e,l,o={}){const{serializer:c,deep:u=!0}=o,d=g(l),s=g(!1),v={read(r){return r??l},write(r){return r}},p={read(r){if(typeof r!="string")return l;try{return JSON.parse(r)}catch{return l}},write(r){try{return JSON.stringify(r)}catch{return""}}},f=c??v,i=c??p,h=typeof window<"u"&&!!window.naimo&&!!window.naimo.storage,_=typeof window<"u"&&!!window.localStorage,C=async()=>{if(h)try{const r=await window.naimo.storage.getItem(e);r!=null&&(d.value=f.read(r))}catch(r){console.error("[useNaimoStorage] 读取 naimo.storage 失败:",r)}else if(_)try{const r=window.localStorage.getItem(e);r!==null&&(d.value=i.read(r))}catch(r){console.error("[useNaimoStorage] 读取 localStorage 失败:",r)}s.value=!0},$=async r=>{if(h)try{const y=f.write(r);await window.naimo.storage.setItem(e,JSON.parse(JSON.stringify(y)))}catch(y){console.error("[useNaimoStorage] 写入 naimo.storage 失败:",y)}else if(_)try{const y=i.write(r);window.localStorage.setItem(e,JSON.stringify(y))}catch(y){console.error("[useNaimoStorage] 写入 localStorage 失败:",y)}};return F(()=>{C()}),W(d,r=>{s.value&&$(r)},{deep:u}),d}const Oe=Se("comic",()=>{const l=Me("comic-reader-static-dirs",[]),o=g([]),c=g(null),u=g(""),d=g([]),s=g(0),v=L("comic-reader-zoom",85),p=g(!1),f=g({library:!1,chapter:!1}),i=g(!1),h=L("comic-reader-auto-scroll-speed",3),_=g(null),C=g(0),$=L("comic-reader-virtual-max-render-count",100),y=L("comic-reader-hotkeys",{scrollDown:"ArrowDown",scrollUp:"ArrowUp",autoScroll:"Space",speedUp:"BracketRight",speedDown:"BracketLeft",nextChapter:"KeyN",prevChapter:"KeyP"}),N=g(!1),T=L("comic-reader-list-layout-mode","list"),P=g(""),a=L("comic-reader-sidebar-width",300),n=L("comic-reader-expanded-mode",!1),m=g({expanded:null,collapsed:null}),B=M(()=>c.value!==null),I=M(()=>u.value!==""),b=M(()=>d.value.length),Q=M(()=>`${s.value} / ${b.value}`);function G(t){l.value.includes(t)||l.value.push(t)}function Z(t){const x=l.value.indexOf(t);x>-1&&l.value.splice(x,1)}function X(t){o.value=t}function Y(t){c.value=t}function ee(t){u.value=t}function te(t){d.value=t,s.value=0}function oe(t){s.value=t}function ae(t){v.value=t}function ne(){p.value=!p.value}function ie(t,x){f.value[t]=x}function re(){i.value=!i.value}function le(t){h.value=Math.max(1,Math.min(10,t))}function se(t){C.value=t%360}function ce(){N.value=!N.value}function ue(t){const x=Math.max(20,Math.min(500,Math.floor(t||0)));$.value=x}function de(t){T.value=t}function ge(t){P.value=t}function fe(t){a.value=Math.max(200,Math.min(800,t))}function me(){n.value=!n.value}function ve(){return n.value?m.value.expanded:m.value.collapsed}function pe(t){n.value?m.value.expanded=t:m.value.collapsed=t}function we(){m.value.expanded=null,m.value.collapsed=null}async function he(t){const x=[...l.value].map(A=>String(A));try{await window.comicReaderAPI.updateFolderTimestamp(x,t),window.$message&&window.$message.success(`已顶置：${t}`),window.$loadMangaList&&await window.$loadMangaList(!0)}catch(A){console.error("顶置漫画失败:",A),window.$message&&window.$message.error("顶置失败")}}async function ye(t){const x=[...l.value].map(A=>String(A));try{await window.comicReaderAPI.deleteMangaFolder(x,t),window.$message&&window.$message.success(`已删除漫画：${t}`),c.value?.name===t&&(c.value=null,u.value="",d.value=[],s.value=0),window.$loadMangaList&&await window.$loadMangaList(!0)}catch(A){console.error("删除漫画失败:",A),window.$message&&window.$message.error("删除失败")}}return{staticDirs:l,mangas:o,currentManga:c,currentChapter:u,currentImages:d,currentPage:s,zoom:v,sidebarCollapsed:p,loading:f,autoScroll:i,autoScrollSpeed:h,autoScrollTimer:_,rotation:C,hotkeys:y,showSettings:N,virtualMaxRenderCount:$,listLayoutMode:T,searchKeyword:P,sidebarWidth:a,expandedMode:n,hasCurrentManga:B,hasCurrentChapter:I,totalPages:b,currentPageInfo:Q,addStaticDir:G,removeStaticDir:Z,setMangas:X,setCurrentManga:Y,setCurrentChapter:ee,setCurrentImages:te,setCurrentPage:oe,setZoom:ae,toggleSidebar:ne,setLoading:ie,toggleAutoScroll:re,setAutoScrollSpeed:le,setRotation:se,toggleSettings:ce,setVirtualMaxRenderCount:ue,setListLayoutMode:de,setSearchKeyword:ge,setSidebarWidth:fe,toggleExpandedMode:me,getCachedMangas:ve,setCachedMangas:pe,clearMangasCache:we,pinManga:he,deleteManga:ye}}),Ae=["src","alt"],Le={key:0,class:"absolute inset-0 flex items-center justify-center bg-black/5 text-gray-400"},_e={key:0,xmlns:"http://www.w3.org/2000/svg",class:"w-1/2 h-auto animate-spin",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},$e={key:1,xmlns:"http://www.w3.org/2000/svg",class:"w-1/2 h-auto",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},Be={key:2,xmlns:"http://www.w3.org/2000/svg",class:"w-1/2 h-auto",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},H="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",Ue=O({__name:"LazyFileImage",props:{item:{},filePath:{},imgStyle:{},imgClass:{},initialSrc:{},waitingSrc:{},loadingSrc:{},errorSrc:{},getScrollContainer:{type:Function}},emits:["loaded","error","visible"],setup(e,{emit:l}){const o=e,c=l,u=g(null),d=g(!1),s=g(o.initialSrc||""),v=M(()=>o.filePath||o.item.path||o.item.url),p=g(null),f=M(()=>o.getScrollContainer?.()||void 0),i=g("waiting"),h=M(()=>{const a={width:"100%",display:"block"};return i.value!=="success"&&(a.aspectRatio="1 / 1"),o.imgStyle?{...a,...o.imgStyle}:a}),_=M(()=>i.value==="success"&&s.value||H),C=async()=>{const a=v.value;if(!a||i.value==="loading"||p.value===a&&i.value==="success")return;const n={...o.item,path:o.filePath||o.item.path};console.debug("[LazyFileImage] 开始加载",{key:o.item.key,path:n.path,url:o.item.url}),i.value="loading";try{const m=await y(n);s.value=m||o.item.url,console.debug("[LazyFileImage] 加载成功",{key:o.item.key,src:s.value}),p.value=a,i.value="success"}catch(m){console.warn("[LazyFileImage] 加载失败",{key:o.item.key,path:n.path,url:o.item.url,error:m}),i.value="error",c("error",m)}};xe(u,([a])=>{a.isIntersecting&&!d.value&&(d.value=!0,c("visible",{item:o.item}),C())},{root:f.value,rootMargin:"800px 0px 800px 0px",threshold:.01}),F(()=>{if(!s.value&&o.initialSrc&&(s.value=o.initialSrc,i.value="success"),!o.initialSrc&&v.value&&!d.value&&u.value){const a=u.value.getBoundingClientRect(),n=window.innerHeight||document.documentElement.clientHeight;a.top<n&&a.bottom>0&&(d.value=!0,C())}}),W(()=>o.filePath,()=>{d.value&&C()});const $=a=>{i.value!=="error"&&(i.value="success"),c("loaded",a)},r=a=>{i.value="error",c("error",a)};async function y(a){return await N(a),s.value||a.url}async function N(a){let n=a.path;if(!n&&a.url.startsWith("file://")&&(n=decodeURIComponent(a.url.replace(/^file:\/\/\//,""))),!n){s.value=a.url;return}try{if(window.naimo?.system?.getLocalImage){const m=await window.naimo.system.getLocalImage(n),B=`image/${T(n)}`,I=P(m,B),b=URL.createObjectURL(I);s.value=b}else s.value=a.url}catch(m){console.error(`加载图片失败: ${n}`,m),s.value=a.url}}function T(a){const n=a.toLowerCase().split(".").pop()||"jpg";return{jpg:"jpeg",jpeg:"jpeg",png:"png",gif:"gif",webp:"webp",bmp:"bmp"}[n]||"jpeg"}function P(a,n){const m=atob(a),B=m.length,I=new Uint8Array(B);for(let b=0;b<B;b++)I[b]=m.charCodeAt(b);return new Blob([I],{type:n})}return(a,n)=>(S(),k("div",{class:"relative overflow-hidden",style:be(h.value)},[w("img",{ref_key:"imgRef",ref:u,src:_.value,alt:e.item.filename,class:j(["w-full h-full block",e.imgClass]),onLoad:$,onError:r},null,42,Ae),i.value!=="success"?(S(),k("div",Le,[i.value==="loading"?(S(),k("svg",_e,[...n[0]||(n[0]=[w("circle",{cx:"12",cy:"12",r:"9",class:"opacity-20"},null,-1),w("path",{d:"M21 12a9 9 0 0 0-9-9"},null,-1)])])):i.value==="waiting"?(S(),k("svg",$e,[...n[1]||(n[1]=[w("circle",{cx:"12",cy:"12",r:"9",class:"opacity-20"},null,-1),w("path",{d:"M12 7v5l3 3"},null,-1)])])):(S(),k("svg",Be,[...n[2]||(n[2]=[w("circle",{cx:"12",cy:"12",r:"9",class:"opacity-20"},null,-1),w("line",{x1:"15",y1:"9",x2:"9",y2:"15"},null,-1),w("line",{x1:"9",y1:"9",x2:"15",y2:"15"},null,-1)])]))])):ke("",!0)],4))}}),Ie={class:"favorite-toggle inline-flex"},Ne=["disabled","title"],Re=["disabled","title"],J="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z",Te=O({__name:"FavoriteToggle",props:{favorited:{type:Boolean,default:!1},loading:{type:Boolean,default:!1},placement:{default:"top"},addTitle:{default:"加入收藏"},removeTitle:{default:"取消收藏"},removeConfirmText:{default:"确认取消收藏？"},confirmPositiveText:{default:"确认"},confirmNegativeText:{default:"取消"}},emits:["add","remove"],setup(e,{emit:l}){const o=e,c=l;function u(){o.loading||c("add")}function d(){o.loading||c("remove")}return(s,v)=>{const p=q("n-popconfirm");return S(),k("div",Ie,[e.favorited?(S(),V(p,{key:0,trigger:"click",placement:e.placement,"positive-text":e.confirmPositiveText,"negative-text":e.confirmNegativeText,disabled:e.loading,onPositiveClick:d},{trigger:R(()=>[w("button",{type:"button",class:j(["favorite-toggle__btn favorite-toggle__btn--active",{"favorite-toggle__btn--disabled":e.loading}]),disabled:e.loading,onClick:v[0]||(v[0]=U(()=>{},["stop"])),title:e.removeTitle,"aria-pressed":"true"},[w("svg",{class:"favorite-toggle__icon",viewBox:"0 0 24 24",fill:"currentColor",stroke:"currentColor","stroke-width":"1.5"},[w("path",{d:J})])],10,Ne)]),default:R(()=>[K(" "+D(e.removeConfirmText),1)]),_:1},8,["placement","positive-text","negative-text","disabled"])):(S(),k("button",{key:1,type:"button",class:j(["favorite-toggle__btn",{"favorite-toggle__btn--disabled":e.loading}]),disabled:e.loading,onClick:U(u,["stop"]),title:e.addTitle,"aria-pressed":"false"},[w("svg",{class:"favorite-toggle__icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[w("path",{d:J})])],10,Re))])}}}),Pe=(e,l)=>{const o=e.__vccOpts||e;for(const[c,u]of l)o[c]=u;return o},Ee=Pe(Te,[["__scopeId","data-v-fcc5fa4e"]]),He="收藏夹";function z(e){if(!e||typeof e!="string")return"unnamed";const l=e.trim();return l?l.replace(/[\\/:*?"<>|]+/g,"_"):"unnamed"}function Je(e){const l=e.comicTitle?z(e.comicTitle):"收藏漫画",o=e.chapterTitle?z(e.chapterTitle):"章节",c=e.originalName||"image",u=c.match(/\.[^/.]+$/),d=u?u[0]:".jpg",s=c.replace(/\.[^/.]+$/,""),v=e.index!==void 0?`#${String(e.index).padStart(3,"0")}`:"",p=Date.now().toString(36);return`${[l,o,v||void 0,z(s),p].filter(Boolean).join("_")}${d}`}const Ke={class:"flex items-center justify-between py-2 px-3 border border-gray-700 rounded"},ze={class:"text-sm"},je={class:"flex items-center gap-2"},De={key:1,class:"flex items-center gap-2"},We=O({__name:"HotkeyBinding",props:{label:{},actionKey:{},currentKey:{}},emits:["update"],setup(e,{emit:l}){const o=e,c=l,u=g(!1);function d(f){return{ArrowDown:"↓",ArrowUp:"↑",ArrowLeft:"←",ArrowRight:"→",Space:"Space",BracketLeft:"[",BracketRight:"]",KeyN:"N",KeyP:"P",ControlLeft:"Ctrl",ControlRight:"Ctrl",ShiftLeft:"Shift",ShiftRight:"Shift",AltLeft:"Alt",AltRight:"Alt",MetaLeft:"Meta",MetaRight:"Meta"}[f]||f.replace(/^Key/,"").replace(/^Digit/,"")}function s(){u.value=!0}function v(){u.value=!1}function p(f){if(!u.value||(f.preventDefault(),f.stopPropagation(),["Control","Shift","Alt","Meta"].includes(f.key)&&!f.code.includes("Left")&&!f.code.includes("Right")))return;const h=f.code;if(h==="Escape"){v();return}c("update",o.actionKey,h),v()}return F(()=>{window.addEventListener("keydown",p,!0)}),Ce(()=>{window.removeEventListener("keydown",p,!0)}),(f,i)=>{const h=q("n-button");return S(),k("div",Ke,[w("span",ze,D(e.label),1),w("div",je,[u.value?(S(),k("div",De,[E(h,{size:"small",onClick:v},{default:R(()=>[...i[0]||(i[0]=[K(" 按键盘设置... ",-1)])]),_:1}),E(h,{size:"small",text:"",onClick:v},{default:R(()=>[...i[1]||(i[1]=[K(" 取消 ",-1)])]),_:1})])):(S(),V(h,{key:0,size:"small",onClick:s},{default:R(()=>[K(D(d(e.currentKey)),1)]),_:1}))])])}}});export{He as B,Ee as F,Ue as _,We as a,Je as b,Pe as c,Oe as u};
